<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Noticia 1</title>
</head>
<script src="./js/script.js"></script>
<body onload="carregarNoticia(), carregarComentarios(), carregarLikes(), verificarLogado()">
    <header id="header">
        <div class="conteudoHeader">
            <span class="logo">
                <a href="index.html">
                    <img style="width: 90px; height: 70px;" src="./imgs/logo.png" alt="">
                </a>
            </span>
            <nav id="nav">
                <ul id="ulNav">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="cadastro.html">Cadastro</a></li>
                    <li><a href="login.html">Login</a></li>
                    <li><a href="quiz.html">Quiz</a></li>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    
                </ul>
            </nav>
        </div>
    </header>

    <div class="containerNoticia">
        <div class="conteudoNoticia">
            <div class="imagemNoticia">
                <img width="1000px" height="600px" id="imagemNoticia" src="" alt="">
            </div>
            <div class="tituloNoticia">
                <h1 id="tituloNoticia">
                    Stephen Thompson propõe duelo de strikers contra Carlos Prates no UFC
                </h1>
                <hr style="border: 1px solid red; width: 95%;">
            </div>
            <div class="informacoesNoticia" id="informacoesNoticia">
                <p id="dataPostagem" style="font-size: 25px; color: red;"></p>
                <div class="likes">
                    <i class="fa fa-solid fa-thumbs-up" onclick="verificarLike()" id="botaoLike"
                        style="cursor: pointer;"></i>
                    <h3 id="qtdLikes">10</h3>
                </div>
            </div>
            <div id="conteudoNoticia" class="textoNoticia">
                <!-- <p class="paragrafoNoticia">
                    A derrota para Ian Machado Garry na luta principal do UFC Kansas City, no último sábado (26),
                    colocou um
                    ponto final na sequência de vitórias de Carlos Prates, mas não parece ter afetado o prestígio que o
                    meio-médio (77 kg) conquistou em pouco mais de um ano na organização. Prova disso é que, apesar do
                    tropeço do brasileiro, um dos principais nomes da categoria na década demonstrou interesse em medir
                    forças com o atleta paulista no octógono mais famoso do mundo.
                </p>
                <p class="paragrafoNoticia">Em entrevista ao ‘MMA Today’, Stephen ‘Wonderboy’ Thompson propôs um desafio entre strikers ao
                    lutador da
                    equipe ‘Fighting Nerds’. Como sempre respeitoso, o carateca americano – que atualmente ocupa a 11ª
                    colocação no ranking dos meio-médios do UFC, duas posições acima do brasileiro – se mostrou
                    empolgado
                    com a possibilidade de duelar contra outro especialista na luta em pé.</p> -->
            </div>
            <div id="excluirNoticiaDiv" class="excluirNoticia">
            </div>
            <div id="comentarios" class="comentarios">
                <div class="comentar">
                    <h2>Faça um comentário</h2>
                    <textarea id="ipt_comentario" placeholder="Digite seu comentário"
                        style="width: 100%; word-break: break-word;" rows="4"></textarea>
                    <button onclick="comentar()">Comentar</button>
                </div>
                <!-- <div class="comentario">
                    <div class="imagemUsuario">
                        <div>
                            <img src="./imgs/defaultProfile.jpg" alt="">
                        </div>
                    </div>
                    <div class="textoComentario">
                        <div class="informacoesUsuario">
                            <h3>Nom3</h3>
                            <h4>Data</h4>
                        </div>
                        <div class="conteudoComentario">
                            <p>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                            </p>
                        </div>
                    </div>
                    <div class="botaoDeletar">
                        <button onclick=deletarComentario()>Deletar</button>
                    </div>
                </div> -->
            </div>
        </div>
    </div>


    <footer>
        <div class="conteudoFooter">
            <div class="redesSociais">
                <a href="https://www.instagram.com/"><img src="./imgs/instagram.png" alt=""></a>
                <a href="https://www.facebook.com/"><img src="./imgs/facebook.png" alt=""></a>
                <a href="https://twitter.com/"><img src="./imgs/twitter.png" alt=""></a>
            </div>
            <div class="copyright">
                <p>Fighting News &copy; 2025</p>
            </div>
            <div class="dados">
                <p>Desenvolvido por: Nicolas B. Javed</p>
                <p>Contato: nicolas.javed@sptech.school</p>
            </div>
        </div>
    </footer>
</body>
<script>
    function carregarNoticia() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        var idUsuarioSession = sessionStorage.ID_USUARIO;
        console.log("ID: " + id);

        var admin = sessionStorage.USUARIO_ADMIN;
        console.log("ADMIN: " + admin);
        if(admin == 1){
            console.log("EXCLUIR NOTICIA")
            excluirNoticiaDiv.innerHTML = `
                <button onclick="excluirNoticia()">Excluir noticia</button>
            `
        }

        if (idUsuarioSession != null && idUsuarioSession != "" && idUsuarioSession != undefined) {
            fetch("/noticias/verificarLikeDado", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                }, body: JSON.stringify({
                    idServer: id,
                    idUsuarioServer: idUsuarioSession
                })
            }).then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (resposta) {
                        if (resposta[0].jaDeuLike == 1) {
                            botaoLike.style.color = "red";
                        } else {
                            botaoLike.style.color = "white";
                        }
                    })
                } else {
                    console.log("Erro ao verificar se já deu like: " + resposta.status);
                }
            })
        }


        fetch("/noticias/carregarNoticia", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idServer: id
            })
        }).then(function (resposta) {

            if (resposta.ok) {
                console.log("Noticia carregada com sucesso!");
                resposta.json().then(function (resposta) {
                    tituloNoticia.innerHTML = resposta[0].tituloNoticia;
                    imagemNoticia.src = resposta[0].caminhoImagem;
                    dataPostagem.innerHTML = resposta[0].dataPostagem.replaceAll("-", "/").replaceAll("T", " ")
                        .replaceAll(".000Z", " ").replaceAll("00:00:00", " ");
                    for (var i = 0; i < resposta.length; i++) {
                        console.log(resposta[i].tituloNoticia);
                        conteudoNoticia.innerHTML += `
                            <p class="paragrafoNoticia">
                                ${resposta[i].conteudo}
                            </p>
                            <br>
                        `
                    }
                })
            } else {
                console.log("Erro ao carregar a noticia: " + resposta.status);
            }

        })
    }

    function excluirNoticia(){
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        fetch("/noticias/excluirNoticia", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idServer: id
            })
        }).then(function(resposta){
            if(resposta.ok){
                resposta.json().then(function(resposta){
                    alert("Notícia excluida com sucesso");
                    window.location = "./index.html"
                })
            }else{
                alert("Erro ao excluir noticia")
            }
        })
    }

    function carregarComentarios() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        var idUsuarioSession = sessionStorage.ID_USUARIO;

        fetch("/noticias/carregarComentarios", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idServer: id
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    for (var i = 0; i < resposta.length; i++) {
                        var idUsuario = resposta[i].idUsuario;

                        if (idUsuarioSession == idUsuario) {
                            comentarios.innerHTML += `
                            <div class="comentario">
                                <div class="imagemUsuario">
                                    <div>
                                    <img src="${resposta[i].caminhoImagem}" alt="">
                                    </div>
                                </div>
                                <div class="textoComentario">
                                    <div class="informacoesUsuario">
                                        <h3>${resposta[i].nome}</h3>
                                        <h4>${resposta[i].data.replaceAll("-", "/").replaceAll("T", " ")
                                    .replaceAll(".000Z", " ")}</h4>
                                    </div>
                                    <div class="conteudoComentario">
                                        <p>
                                            ${resposta[i].comentario}
                                        </p>
                                    </div>
                                </div>
                                <div class="botaoDeletar">
                                    <button onclick=deletarComentario(${resposta[i].idComentario})>Deletar</button>
                                </div>
                            </div>
                            `
                        } else {
                            comentarios.innerHTML += `
                            <div class="comentario">
                                <div class="imagemUsuario">
                                    <div>
                                    <img src="${resposta[i].caminhoImagem}" alt="">
                                    </div>
                                </div>
                                <div class="textoComentario">
                                    <div class="informacoesUsuario">
                                        <h3>${resposta[i].nome}</h3>
                                        <h4>${resposta[i].data.replaceAll("-", "/").replaceAll("T", " ")
                                    .replaceAll(".000Z", " ")}</h4>
                                    </div>
                                    <div class="conteudoComentario">
                                        <p>
                                            ${resposta[i].comentario}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            `
                        }

                        console.log(resposta[i].nome);
                        console.log(resposta[i].data);
                        console.log(resposta[i].comentario);
                    }
                    console.log("Comentarios carregados com sucesso!");
                })
            } else {
                console.log("Erro ao carregar os comentarios: " + resposta.status);
            }
        })
    }

    function carregarLikes() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        fetch("/noticias/carregarLikes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idServer: id
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("QUANTIDADE DE LIKES: " + resposta[0].qtdLikes);
                    qtdLikes.innerHTML = resposta[0].qtdLikes;
                })
            } else {
                console.log("Erro ao carregar os likes: " + resposta.status);
            }
        })
    }

    function verificarLike() {
        const urlParams = new URLSearchParams(window.location.search);
        var idUsuario = sessionStorage.ID_USUARIO;
        console.log("ID USUARIO: " + idUsuario)
        const idNoticia = urlParams.get('id');

        if (idUsuario == null || idUsuario == "" || idUsuario == undefined || idUsuario == "null") {
            alert("Você precisa estar logado para dar like!");
            window.location = "./login.html";
            return;
        }

        fetch("/noticias/jaDeuLike", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idUsuarioServer: idUsuario,
                idNoticiaServer: idNoticia
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    if (resposta[0].jaDeuLike == 1) {
                        console.log("JA DEU LIKE");
                        removerLike(idUsuario, idNoticia);
                        return;
                    } else {
                        darLike(idUsuario, idNoticia);
                        return;
                    }
                })
            } else {
                console.log("Erro ao verificar se já deu like: " + resposta.status);
            }
        })
    }

    function darLike(idUsuario, idNoticia) {
        fetch("/noticias/darLike", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idUsuarioServer: idUsuario,
                idNoticiaServer: idNoticia
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    qtdLikes.innerHTML = Number(qtdLikes.innerText) + 1;
                    botaoLike.style.color = "red";
                })
            } else {
                console.log("Erro ao dar like: " + resposta.status);
            }
        })
    }

    function removerLike(idUsuario, idNoticia) {
        console.log("REMOVER LIKE");
        fetch("/noticias/removerLike", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idUsuarioServer: idUsuario,
                idNoticiaServer: idNoticia
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    qtdLikes.innerHTML = Number(qtdLikes.innerText) - 1;
                    botaoLike.style.color = "white";
                })
            } else {
                console.log("Erro ao remover like: " + resposta.status);
            }
        })
    }

    function comentar() {
        const urlParams = new URLSearchParams(window.location.search);
        var comentario = ipt_comentario.value;
        var idUsuario = sessionStorage.ID_USUARIO;
        const idNoticia = urlParams.get('id');

        if (sessionStorage.ID_USUARIO == null || sessionStorage.ID_USUARIO == "") {
            alert("Você precisa estar logado para comentar!");
            window.location = "./login.html";
            return;
        }

        if (comentario == "" || comentario == null) {
            alert("Preencha o campo de comentário!");
            return;
        }

        if (idNoticia == null || idNoticia == "") {
            alert("Notícia não encontrada!");
            return;
        }

        if (idUsuario == null || idUsuario == "") {
            alert("Você precisa estar logado para comentar!");
            window.location = "./login.html";
        }

        if (comentario.length > 400) {
            alert("O comentário deve ter no máximo 400 caracteres!");
            return;
        }

        fetch("/noticias/comentar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idUsuarioServer: idUsuario,
                comentarioServer: comentario,
                idNoticiaServer: idNoticia
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                window.location.reload();
            } else {
                console.log("Erro ao comentar: " + resposta.status);
            }
        })
    }

    function deletarComentario(idComentario) {
        const urlParams = new URLSearchParams(window.location.search);

        if (sessionStorage.ID_USUARIO == null || sessionStorage.ID_USUARIO == "") {
            alert("Você precisa estar logado!");
            window.location = "./login.html";
            return;
        }

        fetch("/noticias/deletarComentario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            }, body: JSON.stringify({
                idComentarioServer: idComentario
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                window.location.reload();
            } else {
                console.log("Erro ao deletar comentário: " + resposta.status);
            }
        })
    }
</script>

</html>